# SafeShip Integration Tests
# Runs docker compose to test the full application stack

name: Integration Tests

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'docker-compose.yml'
      - 'scripts/**'
      - '.github/workflows/integration-test.yml'
  workflow_dispatch:

env:
  DOTNET_VERSION: '9.0.x'

jobs:
  integration-test:
    name: Docker Compose Integration Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Start services with docker compose
        timeout-minutes: 5
        run: |
          docker compose up -d --build --wait
          docker compose ps
          echo "✅ All services started and healthy"

      - name: Run health check
        run: |
          response=$(curl -sf --max-time 10 http://localhost:8080/health)
          echo "Health check response: $response"
          if [[ "$response" != '"Healthy"' ]]; then
            echo "❌ Health check failed - expected '\"Healthy\"', got '$response'"
            exit 1
          fi
          echo "✅ Health check passed"

      - name: Test home page loads
        run: |
          status_code=$(curl -sL -o /dev/null -w "%{http_code}" --max-time 10 http://localhost:8080/)
          if [[ "$status_code" != "200" ]]; then
            echo "❌ Home page returned status $status_code"
            exit 1
          fi
          echo "✅ Home page loads successfully (HTTP $status_code)"

      - name: Test products page loads
        run: |
          status_code=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 http://localhost:8080/Products)
          if [[ "$status_code" != "200" ]]; then
            echo "❌ Products page returned status $status_code"
            exit 1
          fi
          echo "✅ Products page loads successfully (HTTP $status_code)"

      - name: Show container logs on failure
        if: failure()
        run: |
          echo "=== App Container Logs ==="
          docker compose logs app
          echo ""
          echo "=== SQL Server Container Logs ==="
          docker compose logs sqlserver
          echo ""
          echo "=== DB Init Container Logs ==="
          docker compose logs db-init

      - name: Cleanup
        if: always()
        run: docker compose down -v
